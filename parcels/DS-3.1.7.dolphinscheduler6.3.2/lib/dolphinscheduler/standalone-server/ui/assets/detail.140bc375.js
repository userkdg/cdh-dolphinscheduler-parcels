import{l as D}from"./lodash.02988b15.js";import{u as b,b5 as L,a as I,d as E,at as M,w as P,e as S,ba as w,c as d}from"./index.ccaa682a.js";import{s as C}from"./service.ae1ed8a7.js";import{v as V,u as B,c as j}from"./index.33965dcc.js";import{M as A}from"./index.c665300e.js";import{F as J,g as T}from"./get-elements-by-json.91f61f52.js";import{N as x}from"./Input.f12e0137.js";import{a as k}from"./Select.a0f44759.js";import"./index.c1fd473c.js";import"./Button.3394f0e3.js";import"./is-browser.f4bc45cf.js";import"./use-rtl.d43d8217.js";import"./resolve-slot.d8d7b3cb.js";import"./keysOf.10525521.js";import"./Card.915ef7d2.js";import"./index.7a579f81.js";import"./index.99c68204.js";import"./flatten.995f807f.js";import"./Scrollbar.0dc514b7.js";import"./fade-in.cssr.ac08f6bb.js";import"./VResizeObserver.c3d2397d.js";import"./fade-in-scale-up.cssr.5995d390.js";import"./utils.381519a7.js";import"./Space.f435ce00.js";import"./get-slot.7f666ba0.js";import"./Form.b41344c3.js";import"./FormItem.6b297844.js";import"./format-length.a0cbed4d.js";import"./Grid.8c7d7ba0.js";import"./next-frame-once.e5ee25e8.js";import"./Spin.6c6d001b.js";import"./use-compitable.d1fd83c6.js";import"./Radio.0f909e72.js";import"./RadioGroup.8830dbe4.js";import"./index.9532c9b8.js";import"./DeleteOutlined.b64cb1c2.js";import"./Switch.97f1d4b9.js";import"./InputNumber.9bdbbaa6.js";import"./use-locale.ca4c738c.js";import"./Add.57f827bb.js";import"./Checkbox.ff1b56b7.js";import"./TreeSelect.8a08df17.js";import"./Selection.57d091a8.js";import"./Popover.b48d5d17.js";import"./Suffix.584d00eb.js";function W(n){return C({url:"/ui-plugins/query-by-type",method:"get",params:n})}function $(n){return C({url:`/ui-plugins/${n}`,method:"get"})}function z(){const{t:n}=b(),s={instanceName:"",pluginDefineId:null},e=L({detailFormRef:I(),detailForm:{...s},uiPlugins:[],pluginsLoading:!1,json:[]}),r={model:e.detailForm,requireMarkPlacement:"left",labelPlacement:"left",labelWidth:180,rules:{instanceName:{trigger:"input",required:!0,message:n("security.alarm_instance.alarm_instance_name_tips")},pluginDefineId:{trigger:["blur","change"],required:!0,validator(i,l){if(!l&&l!==0)return new Error(n("security.alarm_instance.select_plugin_tips"))}}}},a=async()=>{if(!e.pluginsLoading){e.pluginsLoading=!0;try{const i=await W({pluginType:"ALERT"});e.uiPlugins=i.map(l=>({label:l.pluginName,value:l.id})),e.pluginsLoading=!1}catch{e.pluginsLoading=!1}}};return{meta:r,state:e,setDetail:i=>{e.detailForm.instanceName=i.instanceName,e.detailForm.pluginDefineId=i.pluginDefineId,i.pluginInstanceParams&&(e.json=JSON.parse(i.pluginInstanceParams))},initForm:()=>{a()},resetForm:()=>{e.detailFormRef.resetValues({...s}),e.json=[]},getFormValues:()=>e.detailForm,changePlugin:async i=>{if(e.pluginsLoading)return;e.pluginsLoading=!0,e.detailForm.pluginDefineId=i;const{pluginParams:l}=await $(i);l&&(e.json=JSON.parse(l)),e.pluginsLoading=!1}}}function G(n){const s=L({saving:!1,loading:!1}),e=(a,o={})=>(a==null||a.forEach(t=>{const u=D.exports.isFunction(t)?t():t;u.value=o[u.field]}),JSON.stringify(a));return{status:s,createOrUpdate:async(a,o)=>{const t=n();if(s.saving)return!1;s.saving=!0;try{return(a==null?void 0:a.instanceName)!==t.instanceName&&await V({alertInstanceName:t.instanceName}),a!=null&&a.id?await B({alertPluginInstanceId:t.pluginDefineId,instanceName:t.instanceName,pluginInstanceParams:e(o,t)},a.id):await j({instanceName:t.instanceName,pluginDefineId:t.pluginDefineId,pluginInstanceParams:e(o,t)}),s.saving=!1,!0}catch{return s.saving=!1,!1}}}}const H={show:{type:Boolean,default:!1},currentRecord:{type:Object,default:{}}},Je=E({name:"DetailModal",props:H,emits:["cancel","update"],setup(n,s){var _;const{t:e}=b(),r=I({}),a=I([]),{meta:o,state:t,setDetail:u,initForm:g,resetForm:c,getFormValues:i,changePlugin:l}=z(),{status:f,createOrUpdate:y}=G(i),m=()=>{c(),r.value={},a.value=[],s.emit("cancel")},p=async()=>{await t.detailFormRef.validate(),await y(n.currentRecord,t.json)&&(m(),s.emit("update"))},U=l,O=(_=M())==null?void 0:_.appContext.config.globalProperties.trim;return P(()=>n.show,async()=>{n.show&&n.currentRecord&&u(n.currentRecord)}),P(()=>t.json,()=>{var v;if(!((v=t.json)!=null&&v.length))return;t.json.forEach(h=>{const N=D.exports.isFunction(h)?h():h;N.name=e("security.alarm_instance."+N.field)});const{rules:F,elements:q}=T(t.json,t.detailForm);r.value=F,a.value=q}),S(()=>{g()}),{t:e,...w(t),...w(f),meta:o,rules:r,elements:a,onChangePlugin:U,onSubmit:p,onCancel:m,trim:O}},render(n){const{show:s,t:e,meta:r,rules:a,elements:o,detailForm:t,uiPlugins:u,pluginsLoading:g,loading:c,saving:i,onChangePlugin:l,onCancel:f,onSubmit:y}=this,{currentRecord:m}=n;return d(A,{show:s,title:e(m!=null&&m.id?"security.alarm_instance.edit_alarm_instance":"security.alarm_instance.create_alarm_instance"),onConfirm:y,confirmLoading:i||c,onCancel:f},{default:()=>d(J,{ref:"detailFormRef",loading:c||g,meta:{...r,rules:{...r.rules,...a},elements:[{path:"instanceName",label:e("security.alarm_instance.alarm_instance_name"),widget:d(x,{allowInput:this.trim,value:t.instanceName,"onUpdate:value":p=>t.instanceName=p,placeholder:e("security.alarm_instance.alarm_instance_name_tips")},null)},{path:"pluginDefineId",label:e("security.alarm_instance.select_plugin"),widget:d(k,{value:t.pluginDefineId,"onUpdate:value":p=>t.pluginDefineId=p,options:u,disabled:!!(m!=null&&m.id),placeholder:e("security.alarm_instance.select_plugin_tips"),"on-update:value":l},null)},...o]},layout:{cols:24}},null)})}});export{Je as default};

import{bu as J,w as x,a as S,bJ as $,e as Z,b5 as ge,u as ee,t as ve,cg as ke,d as Te,bB as he,B as Q,z as U,n as F,b as Ce,c as D}from"./index.ccaa682a.js";import Ne from"./dag-toolbar.dad1c01c.js";import Se from"./dag-canvas.53651158.js";import Le from"./dag-sidebar.567394c4.js";import{S as G}from"./dag.module.c7fce5f9.js";import{u as ye,D as De}from"./dag-auto-layout-modal.1793cc7f.js";import"./track.2f5b50c6.js";import{l as M}from"./lodash.02988b15.js";import{u as Ee}from"./index.cb24df24.js";import we from"./dag-context-menu.4567de56.js";import"./gForce.17615aed.js";import{a as be,X as Re,N as Me,i as Ie}from"./dag-config.e2eb20b1.js";import{T as j}from"./task-type.8f811883.js";import"./service.ae1ed8a7.js";import xe from"./dag-node-status.3123c86b.js";import{u as Ve}from"./task-node.ff5737f9.js";import{g as Ae}from"./index.f525e57e.js";import{f as Oe,N as Pe}from"./detail-modal.03e465d3.js";import{t as _e}from"./common.0c468cf3.js";import{a as Ue}from"./index.40a25123.js";import je from"./version-modal.4361e6a9.js";import Be from"./dag-save-modal.9eb012fe.js";import{S as Xe}from"./start-modal.eb19d327.js";import{L as Ye,q as He}from"./index.f6b1d0fc.js";/* empty css                 */import"./use-text-copy.3e78d5d4.js";import"./use-message.f86e8236.js";import"./dag-startup-param.55c24d13.js";import"./index.10c5a06c.js";import"./index.db4740c8.js";import"./SettingOutlined.675e55ec.js";import"./PauseCircleOutlined.f81cacab.js";import"./CloseCircleOutlined.7f4d3411.js";import"./CheckCircleOutlined.b6132804.js";import"./EditOutlined.84f6aa5d.js";import"./index.15a20265.js";import"./variables-view.1240feac.js";import"./index.ea22358f.js";import"./Button.3394f0e3.js";import"./is-browser.f4bc45cf.js";import"./use-rtl.d43d8217.js";import"./resolve-slot.d8d7b3cb.js";import"./CopyOutlined.3454e508.js";import"./SearchOutlined.2201cd30.js";import"./DownloadOutlined.e1724915.js";import"./SyncOutlined.20c34c75.js";import"./DeleteOutlined.b64cb1c2.js";import"./FullscreenOutlined.6cc67f3a.js";import"./InfoCircleOutlined.94554f26.js";import"./Tooltip.14e7654c.js";import"./Popover.b48d5d17.js";import"./index.99c68204.js";import"./flatten.995f807f.js";import"./Scrollbar.0dc514b7.js";import"./fade-in.cssr.ac08f6bb.js";import"./VResizeObserver.c3d2397d.js";import"./utils.381519a7.js";import"./format-length.a0cbed4d.js";import"./use-compitable.d1fd83c6.js";import"./next-frame-once.e5ee25e8.js";import"./Icon.808259cb.js";import"./text.b2059286.js";import"./Selection.57d091a8.js";import"./index.7a579f81.js";import"./use-locale.ca4c738c.js";import"./Suffix.584d00eb.js";import"./Select.a0f44759.js";import"./fade-in-scale-up.cssr.5995d390.js";import"./toNumber.9dd28a65.js";import"./debounce.0c31022e.js";import"./Spin.6c6d001b.js";import"./index.c665300e.js";import"./index.c1fd473c.js";import"./keysOf.10525521.js";import"./Card.915ef7d2.js";import"./Space.f435ce00.js";import"./get-slot.7f666ba0.js";import"./RadioButton.84587554.js";import"./RadioGroup.8830dbe4.js";import"./Form.b41344c3.js";import"./FormItem.6b297844.js";import"./InputNumber.9bdbbaa6.js";import"./Input.f12e0137.js";import"./Add.57f827bb.js";import"./detail.76ffd3ed.js";import"./get-elements-by-json.91f61f52.js";import"./Grid.8c7d7ba0.js";import"./Radio.0f909e72.js";import"./index.9532c9b8.js";import"./Switch.97f1d4b9.js";import"./Checkbox.ff1b56b7.js";import"./TreeSelect.8a08df17.js";import"./ArrowUpOutlined.50724439.js";import"./index.8f0bc55d.js";import"./index.22db9fb0.js";import"./index.97c7c8f2.js";import"./index.12862679.js";import"./index.fd192f71.js";import"./Ellipsis.31968545.js";import"./index.ed11a284.js";import"./index.f349419b.js";import"./ProfileOutlined.82b3a2e8.js";import"./use-modal.3beefbd6.js";import"./index.126e1851.js";import"./ExclamationCircleOutlined.9cbc41f9.js";import"./Popconfirm.b8629776.js";import"./DataTable.f685dba1.js";import"./ArrowDown.c45c82c0.js";import"./Dropdown.16d7f975.js";import"./ChevronRight.efc71575.js";import"./use-keyboard.db487137.js";import"./Forward.6cc09413.js";import"./index.0c5e8c9e.js";import"./ButtonGroup.121b6732.js";import"./PlusCircleOutlined.53e873cd.js";import"./DatePicker.34177339.js";import"./throttle.1a3a727c.js";function Fe(){function o(a,v,p){const s={};v.forEach(n=>{const t=n.getTargetCellId();s[t]=!0});const c=n=>!s[n],g={};a.forEach(n=>{const t=n.id,i=p.find(l=>l.code===Number(t));i&&(g[t]=i)});const h=a.filter(n=>c(n.id)).map(n=>{const t=g[n.id];return{name:"",preTaskCode:0,preTaskVersion:0,postTaskCode:t.code,postTaskVersion:t.version||0,conditionType:"NONE",conditionParams:{}}}),r=v.map(n=>{const t=n.getLabels(),i=M.exports.get(t,["0","attrs","label","text"],""),l=n.getSourceCellId(),f=g[l],d=n.getTargetCellId(),N=g[d];return{name:i,preTaskCode:f.code,preTaskVersion:f.version||0,postTaskCode:N.code,postTaskVersion:N.version||0,conditionType:"NONE",conditionParams:{}}});return h.concat(r)}function u(a){return a.map(v=>{const p=+v.id,{x:s,y:c}=v.getPosition();return{taskCode:p,x:s,y:c}})}return{getLocations:u,getConnects:o}}function Ge(o){const{graph:u}=o,{buildNode:a,buildEdge:v}=te();function p(t,i){var f;const l=(f=u.value)==null?void 0:f.getCellById(t);if(l){const d=J.truncateText(i,18);l.attr("title/text",d),l.setData({taskName:i})}}function s(t,i,l,f,d={x:100,y:100}){var w;if(!j[i])return;const N=a(t,i,l,f,d);(w=u.value)==null||w.addNode(N)}function c(t){var i;(i=u.value)==null||i.removeNode(t)}const g=t=>{var f,d;const i=(f=u.value)==null?void 0:f.getCellById(t);return i?((d=u.value)==null?void 0:d.getConnectedEdges(i))||[]:[]};return{setNodeName:p,setNodeEdge:(t,i)=>{const l=g(t);l!=null&&l.length&&l.forEach(f=>{var d,N;((d=f.getTargetNode())==null?void 0:d.id)===t&&((N=u.value)==null||N.removeEdge(f))}),i.forEach(f=>{var d;(d=u.value)==null||d.addEdge(v(String(f),t))})},addNode:s,removeNode:c,getSources:t=>{const i=g(t);if(!i.length)return[];const l=[];return i.forEach(f=>{const d=f.getSourceNode();d&&d.id!==t&&l.push(Number(d.id))}),l},getTargets:t=>{const i=g(t);if(!i.length)return[];const l=[];return i.forEach(f=>{const d=f.getTargetNode();d&&d.id!==t&&l.push(Number(d.id))}),l}}}function te(){function o(p){let s=null;return p?(s=JSON.parse(p),Array.isArray(s)?s:null):s}function u(p,s,c="",g=!1){return{shape:be,source:{cell:p},target:{cell:s},labels:c?[c]:void 0,attrs:{line:{strokeDasharray:g?"5 5":"none"}}}}function a(p,s,c,g,h={x:100,y:100}){const r=c?J.truncateText(c,18):p;return{id:p,shape:Re,x:h.x,y:h.y,data:{taskType:s,taskName:c||p,flag:g,taskExecuteType:j[s].taskExecuteType},attrs:{image:{"xlink:href":`/dolphinscheduler/ui/images/task-icons/${(s!=="FLINK_STREAM"?s:"FLINK").toLocaleLowerCase()}.png`},title:{text:r},rect:{fill:g==="NO"?"#f3f3f5":"#ffffff"}}}}function v(p){const s=[],c=[],g=o(p.processDefinition.locations)||[],h=p.taskDefinitionList,r=p.processTaskRelationList,n={};return h.forEach(t=>{const i=g.find(f=>f.taskCode===t.code)||{},l=a(t.code+"",t.taskType,t.name,t.flag,{x:i.x,y:i.y});s.push(l),n[String(t.code)]=t.taskType}),r.filter(t=>!!t.preTaskCode).forEach(t=>{const i=j[n[t.preTaskCode]].taskExecuteType==="STREAM"||j[n[t.postTaskCode]].taskExecuteType==="STREAM",l=u(t.preTaskCode+"",t.postTaskCode+"",t.name,i);c.push(l)}),{nodes:s,edges:c}}return{buildNode:a,buildEdge:u,buildGraph:v}}function Je(o){const{graph:u,definition:a}=o,{buildGraph:v}=te();return x([u,a],()=>{u.value&&a.value&&u.value.fromJSON(v(a.value))}),{}}function $e(o){const{readonly:u,graph:a,appendTask:v}=o,p=$(),s=Number(p.params.projectCode),c=S({x:0,y:0,type:"SHELL"});function g(n,t){if(u.value){n.preventDefault();return}c.value={x:n.offsetX,y:n.offsetY,type:t}}function h(n){if(n.stopPropagation(),n.preventDefault(),!u.value&&c.value&&a.value&&s){const{type:t,x:i,y:l}=c.value,{x:f,y:d}=a.value.clientToLocal(n.clientX,n.clientY);Ae(1,s).then(w=>{const[I]=w;v(I,t,{x:f-i,y:d-l})})}}const r=n=>{n.preventDefault()};return{onDragStart:g,onDrop:h,onDragenter:r,onDragover:r,onDragleave:r}}function Ke(o){const{graph:u,definition:a}=o,{addNode:v,removeNode:p,getSources:s,getTargets:c,setNodeName:g,setNodeEdge:h}=Ge({graph:u}),r=S((a==null?void 0:a.value)||{processDefinition:{},processTaskRelationList:[],taskDefinitionList:[]}),n=S({taskType:"SHELL",code:0,name:""}),t=S(!1);function i(e,T,m){v(e+"",T,"","YES",m),r.value.taskDefinitionList.push({code:e,taskType:T,name:""}),d({code:e,taskType:T,name:""})}function l(e,T,m,C,L,y){v(T+"",C,e,L,y);const B=r.value.taskDefinitionList.find(O=>O.code===m),A={...M.exports.cloneDeep(B),code:T,name:e};r.value.taskDefinitionList.push(A)}function f(e,T){r.value.taskDefinitionList=r.value.taskDefinitionList.filter(m=>!e.includes(m.code)),e.forEach(m=>{M.exports.remove(r.value.processTaskRelationList,C=>C.postTaskCode===m||C.preTaskCode===m)}),T==null||T.forEach(m=>{if(m.isEdge()){const C=m.getSourceCellId(),L=m.getTargetCellId();M.exports.remove(r.value.processTaskRelationList,y=>String(y.postTaskCode)===L&&String(y.preTaskCode)===C)}})}function d(e){n.value=e,t.value=!0}function N(e){const T=r.value.taskDefinitionList.find(m=>m.code===e);T&&(n.value=T),R(s(String(e)),e),V(e),t.value=!0}function w({data:e}){const T=Oe(e).taskDefinitionJsonObj;r.value.taskDefinitionList=r.value.taskDefinitionList.map(m=>{var C;return m.code===((C=n.value)==null?void 0:C.code)?(g(m.code+"",T.name),h(String(m.code),e.preTasks),R(e.preTasks,m.code),{...T,version:m.version,code:m.code,taskType:n.value.taskType,id:m.id}):m}),t.value=!1}function I(){t.value=!1,n.value.name||(p(String(n.value.code)),M.exports.remove(r.value.taskDefinitionList,e=>e.code===n.value.code))}function R(e,T){var m,C;(C=(m=r.value)==null?void 0:m.processTaskRelationList)!=null&&C.length&&M.exports.remove(r.value.processTaskRelationList,L=>L.postTaskCode===T),e!=null&&e.length&&e.forEach(L=>{var y;(y=r.value)==null||y.processTaskRelationList.push({postTaskCode:T,preTaskCode:L,name:"",preTaskVersion:1,postTaskVersion:1,conditionType:"NONE",conditionParams:{}})})}function V(e){c(String(e)).forEach(m=>{var C,L;(C=r.value)!=null&&C.processTaskRelationList.find(y=>y.postTaskCode===m&&y.preTaskCode===e)||(L=r.value)==null||L.processTaskRelationList.push({postTaskCode:m,preTaskCode:e,name:"",preTaskVersion:1,postTaskVersion:1,conditionType:"NONE",conditionParams:{}})})}return Z(()=>{u.value&&u.value.on("cell:dblclick",({cell:e})=>{const T=Number(e.id);N(T)})}),x(a,()=>{a.value&&(r.value=a.value)}),{currTask:n,taskModalVisible:t,processDefinition:r,taskConfirm:w,taskCancel:I,appendTask:i,editTask:N,copyTask:l,removeTasks:f}}function qe(o){const{graph:u}=o,a=ge({menuVisible:!1,startModalShow:!1,logTaskId:-1,logTaskType:"",pageX:0,pageY:0,menuCell:{},showModalRef:S(!1),row:{},logRef:"",logLoadingRef:S(!0),skipLineNum:S(0),limit:S(1e3),taskCode:""}),v=()=>{var c;a.menuVisible=!1,(c=u.value)==null||c.unlockScroller()},p=c=>{a.startModalShow=!0,a.taskCode=String(c)},s=(c,g)=>{a.logTaskId=c,a.logTaskType=g,a.showModalRef=!0};return Z(()=>{u.value&&u.value.on("node:contextmenu",({cell:c,x:g,y:h})=>{a.menuCell=c;const r=u.value.localToPage(g,h);a.pageX=r.x,a.pageY=r.y,a.menuVisible=!0,u.value.lockScroller()})}),{nodeVariables:a,menuHide:v,menuStart:p,viewLog:s}}function ze(o){const{graph:u}=o,a=$(),v=S([]),{t:p}=ee(),s=Ve(),c=(h,r,n)=>{var l,f;const t=_e(p)[r],i=(l=u.value)==null?void 0:l.getCellById(h);if(i){i.removeMarkup(),i.setMarkup(Me.markup.concat(Ie));const d=(f=u.value)==null?void 0:f.findViewByCell(i),N=d==null?void 0:d.find("div")[0],w=ve(xe,{t:p,taskInstance:n,stateProps:t});ke(w,N)}};return{taskList:v,refreshTaskStatus:()=>{const h=Number(a.params.projectCode),r=Number(a.params.id);Ue(r,h).then(n=>{window.$message.success(p("project.workflow.refresh_status_succeeded")),v.value=n.taskList,v.value&&v.value.forEach(t=>{c(t.taskCode,t.state,t),t.dependentResult&&s.updateDependentResult(JSON.parse(t.dependentResult))})})}}}const We={instance:{type:Object,default:void 0},definition:{type:Object,default:void 0},readonly:{type:Boolean,default:!1},projectCode:{type:Number,default:0}},un=Te({name:"workflow-dag",props:We,emits:["refresh","save"],setup(o,u){const{t:a}=ee(),v=$(),p=he();Q("readonly",U(o,"readonly"));const s=S();Q("graph",s),u.expose(s);const{visible:c,toggle:g,formValue:h,formRef:r,submit:n,cancel:t}=ye({graph:s}),{taskConfirm:i,taskModalVisible:l,currTask:f,taskCancel:d,appendTask:N,editTask:w,copyTask:I,processDefinition:R,removeTasks:V}=Ke({graph:s,definition:U(o,"definition")}),{nodeVariables:e,menuHide:T,menuStart:m,viewLog:C}=qe({graph:s}),L=F(()=>o.definition?v.name==="workflow-definition-detail"&&o.definition.processDefinition.releaseState==="ONLINE":!1),y=F(()=>o.instance?o.instance.state==="WAITING_THREAD"||o.instance.state==="SUCCESS"||o.instance.state==="PAUSE"||o.instance.state==="FAILURE"||o.instance.state==="STOP":o.definition?o.definition.processDefinition.releaseState==="OFFLINE":!1),B=F(()=>{if(e.menuCell){const k=Number(e.menuCell.id);return K.value.find(E=>E.taskCode===k)}else return}),A=S();x(()=>l.value,()=>{if(o.instance&&l.value){const k=f.value.code;A.value=K.value.find(E=>E.taskCode===k)}});const O=S(),{taskList:K,refreshTaskStatus:P}=ze({graph:s}),{onDragStart:oe,onDrop:ne}=$e({graph:s,readonly:U(o,"readonly"),appendTask:N});Je({graph:s,definition:U(o,"definition")});const b=S(!1),se=k=>{typeof k=="boolean"?b.value=k:b.value=!b.value},ae=()=>{u.emit("refresh"),b.value=!1},_=S(!1),X=k=>{typeof k=="boolean"?_.value=k:_.value=!b.value},{getConnects:ie,getLocations:re}=Fe(),le=k=>{var z,W;const E=((z=s.value)==null?void 0:z.getEdges())||[],H=((W=s.value)==null?void 0:W.getNodes())||[];if(!H.length){window.$message.error(a("project.dag.node_not_created")),X(!1);return}const me=ie(H,E,R.value.taskDefinitionList),pe=re(H);u.emit("save",{taskDefinitions:R.value.taskDefinitionList,saveForm:k,connects:me,locations:pe}),X(!1)},q=(k,E)=>{l.value=!1,C(k,E),Y()},Y=()=>{const{state:k}=Ee(He({taskInstanceId:e.logTaskId,limit:e.limit,skipLineNum:e.skipLineNum}).then(E=>{E.message?(e.logRef+=E.message,e.limit+=1e3,e.skipLineNum+=E.lineNum,Y()):e.logLoadingRef=!1}),{});return k},ue=()=>{e.logRef="",e.limit=1e3,e.skipLineNum=0,Y()},ce=()=>{J.downloadFile("log/download-log",{taskInstanceId:e.logTaskId})},de=()=>{e.showModalRef=!1},fe=()=>{n(),o.instance&&P()};return x(()=>o.definition,()=>{o.instance&&(P(),O.value=setInterval(()=>P(),9e4))}),x(()=>e.showModalRef,()=>{e.showModalRef||(e.row={},e.logRef="",e.logLoadingRef=!0,e.skipLineNum=0,e.limit=1e3)}),Ce(()=>clearInterval(O.value)),()=>D("div",{class:[G.dag,G[`dag-${p.darkTheme?"dark":"light"}`]]},[D(Ne,{layoutToggle:g,instance:o.instance,definition:o.definition,onVersionToggle:se,onSaveModelToggle:X,onRemoveTasks:V,onRefresh:P},null),D("div",{class:G.content},[D(Le,{onDragStart:oe},null),D(Se,{onDrop:ne},null)]),D(De,{visible:c.value,submit:fe,cancel:t,formValue:h,formRef:r},null),!!o.definition&&D(je,{isInstance:!!o.instance,row:o.definition.processDefinition,"onUpdate:row":k=>o.definition.processDefinition=k,show:b.value,"onUpdate:show":k=>b.value=k,onUpdateList:ae},null),D(Be,{show:_.value,"onUpdate:show":k=>_.value=k,onSave:le,definition:o.definition,instance:o.instance},null),D(Pe,{readonly:o.readonly,show:l.value,projectCode:o.projectCode,processInstance:o.instance,taskInstance:A.value,onViewLog:q,data:f.value,definition:R,onSubmit:i,onCancel:d},null),D(we,{startDisplay:L.value,menuDisplay:y.value,taskInstance:B.value,cell:e.menuCell,visible:e.menuVisible,left:e.pageX,top:e.pageY,onHide:T,onStart:m,onEdit:w,onCopyTask:I,onRemoveTasks:V,onViewLog:q},null),!!o.definition&&D(Xe,{row:o.definition.processDefinition,"onUpdate:row":k=>o.definition.processDefinition=k,show:e.startModalShow,"onUpdate:show":k=>e.startModalShow=k,taskCode:e.taskCode},null),!!o.instance&&D(Ye,{showModalRef:e.showModalRef,logRef:e.logRef,row:e.row,showDownloadLog:!0,logLoadingRef:e.logLoadingRef,onConfirmModal:de,onRefreshLogs:ue,onDownloadLogs:ce},null)])}});export{un as default};
